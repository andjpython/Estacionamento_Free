<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="csrf-token" content="{{ csrf_token() }}">
  <title>√Årea do Supervisor - Recanto das Flores I</title>
  <link rel="icon" type="image/png" href="/static/imagens/icon.png">
  <link rel="stylesheet" href="/static/style.css">
  <link rel="stylesheet" href="/static/feedback.css">
  <style>
    /* Estilos espec√≠ficos para o sistema do supervisor */
    .supervisor-container {
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px;
      font-family: 'Montserrat', sans-serif;
    }

    .header-supervisor {
      text-align: center;
      margin-bottom: 30px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 30px;
      border-radius: 15px;
      box-shadow: 0 10px 30px rgba(0,0,0,0.2);
    }

    .header-supervisor h1 {
      margin: 0;
      font-size: 2.5em;
      font-weight: 700;
    }

    .header-supervisor h2 {
      margin: 10px 0 0 0;
      font-size: 1.2em;
      opacity: 0.9;
    }

    .supervisor-info {
      background: #d4edda;
      color: #155724;
      padding: 15px;
      border-radius: 8px;
      margin-bottom: 20px;
      text-align: center;
      font-weight: 600;
    }

    .menu-supervisor {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-bottom: 30px;
    }

    .card-supervisor {
      background: white;
      border-radius: 15px;
      padding: 25px;
      box-shadow: 0 5px 20px rgba(0,0,0,0.1);
      border: 1px solid #e0e0e0;
    }

    .card-supervisor h3 {
      color: #333;
      margin-bottom: 20px;
      font-size: 1.4em;
      border-bottom: 3px solid #667eea;
      padding-bottom: 10px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .form-supervisor {
      display: grid;
      gap: 15px;
    }

    .form-row {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 15px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
    }

    .form-group label {
      margin-bottom: 8px;
      font-weight: 600;
      color: #555;
    }

    .form-group input, .form-group select {
      padding: 12px;
      border: 2px solid #e0e0e0;
      border-radius: 8px;
      font-size: 14px;
      transition: border-color 0.3s ease;
    }

    .form-group input:focus, .form-group select:focus {
      outline: none;
      border-color: #667eea;
      box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
    }

    .btn-supervisor {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      justify-self: start;
    }

    .btn-supervisor:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .btn-info {
      background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-info:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .btn-danger {
      background: linear-gradient(135deg, #ff6b6b 0%, #ee5a24 100%);
      color: white;
      border: none;
      padding: 12px 25px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
    }

    .btn-danger:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    .resultado {
      margin-top: 15px;
      padding: 12px;
      border-radius: 8px;
      font-weight: 600;
    }

    .resultado.sucesso {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }

    .resultado.erro {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    .resultado.info {
      background-color: #d1ecf1;
      color: #0c5460;
      border: 1px solid #bee5eb;
    }

    .lista-funcionarios {
      margin-top: 15px;
      max-height: 200px;
      overflow-y: auto;
      border: 1px solid #e0e0e0;
      border-radius: 8px;
      padding: 10px;
    }

    .lista-funcionarios li {
      padding: 8px;
      border-bottom: 1px solid #f0f0f0;
      list-style: none;
    }

    .lista-funcionarios li:last-child {
      border-bottom: none;
    }

    .historico-item {
      background: #f8f9fa;
      border: 1px solid #e9ecef;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 10px;
    }

    .historico-item strong {
      color: #667eea;
    }

    .loading {
      text-align: center;
      padding: 15px;
      color: #666;
    }

    .hidden {
      display: none !important;
    }

    .voltar-btn {
      background: linear-gradient(135deg, #6c757d 0%, #495057 100%);
      color: white;
      border: none;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s ease;
      text-decoration: none;
      display: inline-block;
      margin-bottom: 20px;
    }

    .voltar-btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(0,0,0,0.2);
    }

    @media (max-width: 768px) {
      .menu-supervisor {
        grid-template-columns: 1fr;
      }
      
      .form-row {
        grid-template-columns: 1fr;
      }
      
      .header-supervisor h1 {
        font-size: 2em;
      }
    }
  </style>
</head>
<body>
  <div class="supervisor-container">
    <!-- Bot√£o Voltar -->
    <a href="/sistema" class="voltar-btn">‚Üê Voltar ao Sistema</a>

    <!-- Header do Supervisor -->
    <div class="header-supervisor">
      <h1>üë®‚Äçüíº √Årea do Supervisor</h1>
      <h2>Recanto das Flores I - Gest√£o Completa</h2>
    </div>

    <!-- Informa√ß√µes do Supervisor -->
    <div class="supervisor-info">
      ‚úÖ Login confirmado com sucesso! | Supervisor: {{ nome_supervisor }}
      <div style="margin-top: 15px;">
        <button onclick="logoutSupervisor()" style="
          background: linear-gradient(135deg, #ff6b6b 0%, #ee5a52 100%);
          color: white;
          border: none;
          padding: 10px 20px;
          border-radius: 6px;
          font-size: 13px;
          font-weight: 600;
          cursor: pointer;
          transition: all 0.3s ease;
          box-shadow: 0 3px 10px rgba(255, 107, 107, 0.3);
        ">üö™ Logout Supervisor</button>
      </div>
    </div>

    <!-- Menu do Supervisor -->
    <div class="menu-supervisor">
      <!-- Cadastrar Funcion√°rio -->
      <div class="card-supervisor">
        <h3>üë§ Cadastrar Funcion√°rio</h3>
        <form id="formCadastrarFuncionario" class="form-supervisor">
          <div class="form-row">
            <div class="form-group">
              <label for="nomeFuncionario">Nome do Funcion√°rio:</label>
              <input type="text" id="nomeFuncionario" name="nome" placeholder="Nome completo" required>
            </div>
            <div class="form-group">
              <label for="matriculaFuncionario">Matr√≠cula (4 d√≠gitos):</label>
              <input type="text" id="matriculaFuncionario" name="matricula" placeholder="0000" maxlength="4" required>
            </div>
          </div>
          <div class="form-group">
            <label for="senhaSupervisorCadastro">Senha do Supervisor:</label>
            <input type="password" id="senhaSupervisorCadastro" name="senha_supervisor" placeholder="Confirme sua senha" required>
          </div>
          <button type="submit" class="btn-supervisor">Cadastrar Funcion√°rio</button>
        </form>
        <div id="resultadoCadastrarFuncionario" class="resultado hidden"></div>
      </div>

      <!-- Listar Funcion√°rios -->
      <div class="card-supervisor">
        <h3>üìã Listar Funcion√°rios</h3>
        <form id="formListarFuncionarios" class="form-supervisor">
          <div class="form-group">
            <label for="senhaSupervisorListar">Senha do Supervisor:</label>
            <input type="password" id="senhaSupervisorListar" name="senha_supervisor" placeholder="Confirme sua senha" required>
          </div>
          <button type="submit" class="btn-info">Listar Funcion√°rios</button>
        </form>
        <div id="resultadoListarFuncionarios" class="resultado hidden"></div>
        <ul id="listaFuncionarios" class="lista-funcionarios hidden"></ul>
      </div>

      <!-- Funcion√°rios Logados -->
      <div class="card-supervisor">
        <h3>üü¢ Funcion√°rios Logados</h3>
        <button class="btn-info" onclick="listarFuncionariosLogados()">Atualizar Lista</button>
        <div id="loadingLogados" class="loading hidden">Carregando...</div>
        <div id="resultadoLogados" class="resultado hidden"></div>
        <ul id="listaFuncionariosLogados" class="lista-funcionarios"></ul>
      </div>

      <!-- Hist√≥rico por Matr√≠cula -->
      <div class="card-supervisor">
        <h3>üìú Hist√≥rico por Matr√≠cula</h3>
        <form id="formHistoricoMatricula" class="form-supervisor">
          <div class="form-group">
            <label for="matriculaHistorico">Matr√≠cula do Funcion√°rio:</label>
            <input type="text" id="matriculaHistorico" name="matricula" placeholder="Digite a matr√≠cula" required>
          </div>
          <button type="submit" class="btn-info">Buscar Hist√≥rico</button>
        </form>
        <div id="loadingHistorico" class="loading hidden">Buscando hist√≥rico...</div>
        <div id="resultadoHistorico" class="resultado hidden"></div>
        <div id="listaHistorico"></div>
      </div>

      <!-- Ver Hist√≥rico Completo -->
      <div class="card-supervisor">
        <h3>üìä Hist√≥rico Completo</h3>
        <button class="btn-info" onclick="verHistoricoCompleto()">Ver Hist√≥rico Completo</button>
        <div id="loadingHistoricoCompleto" class="loading hidden">Carregando hist√≥rico...</div>
        <div id="resultadoHistoricoCompleto" class="resultado hidden"></div>
        <div id="listaHistoricoCompleto"></div>
      </div>

      <!-- Remover Funcion√°rio -->
      <div class="card-supervisor">
        <h3>üóëÔ∏è Remover Funcion√°rio</h3>
        <form id="formRemoverFuncionario" class="form-supervisor">
          <div class="form-group">
            <label for="matriculaRemover">Matr√≠cula do Funcion√°rio:</label>
            <input type="text" id="matriculaRemover" name="matricula" placeholder="Digite a matr√≠cula" required>
          </div>
          <div class="form-group">
            <label for="senhaSupervisorRemover">Senha do Supervisor:</label>
            <input type="password" id="senhaSupervisorRemover" name="senha_supervisor" placeholder="Confirme sua senha" required>
          </div>
          <button type="submit" class="btn-danger">Remover Funcion√°rio</button>
        </form>
        <div id="resultadoRemoverFuncionario" class="resultado hidden"></div>
      </div>

      <!-- Listar Ve√≠culos -->
      <div class="card-supervisor">
        <h3>üöó Listar Ve√≠culos Cadastrados</h3>
        <button class="btn-info" onclick="listarVeiculosCadastrados()">Listar Ve√≠culos</button>
        <div id="loadingVeiculos" class="loading hidden">Carregando ve√≠culos...</div>
        <div id="resultadoVeiculos" class="resultado hidden"></div>
        <div id="listaVeiculos"></div>
      </div>
    </div>
  </div>

  <script src="/static/auth.js"></script>
  <script>
    // Obter token CSRF
    const csrfToken = document.querySelector('meta[name="csrf-token"]').getAttribute('content');

    // Fun√ß√£o para mostrar resultado
    function mostrarResultado(elementId, mensagem, tipo) {
      const elemento = document.getElementById(elementId);
      elemento.textContent = mensagem;
      elemento.className = `resultado ${tipo}`;
      elemento.classList.remove('hidden');
    }

    // Usar a fun√ß√£o de requisi√ß√£o autenticada com CSRF
    async function fazerRequisicao(url, dados = null, metodo = 'GET') {
      const opcoes = {
        method: metodo,
        headers: {
          'Content-Type': 'application/json',
          'X-CSRFToken': csrfToken
        }
      };

      // Adicionar token JWT se dispon√≠vel
      const token = localStorage.getItem('authToken');
      if (token) {
        opcoes.headers['Authorization'] = `Bearer ${token}`;
      }

      if (dados) {
        opcoes.body = JSON.stringify(dados);
      }

      const resposta = await fetch(url, opcoes);
      const resultado = await resposta.json();
      
      return { sucesso: resposta.ok, dados: resultado };
    }

    // Fun√ß√£o para limpar formul√°rio
    function limparFormulario(formId) {
      const form = document.getElementById(formId);
      if (form) {
        form.reset();
      }
    }

    // Cadastrar Funcion√°rio
    document.getElementById('formCadastrarFuncionario').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const dados = Object.fromEntries(formData);
      
      const resultado = await fazerRequisicao('/cadastrar-funcionario', dados, 'POST');
      
      if (resultado.sucesso) {
        mostrarResultado('resultadoCadastrarFuncionario', resultado.dados.mensagem, 'sucesso');
        limparFormulario('formCadastrarFuncionario');
      } else {
        mostrarResultado('resultadoCadastrarFuncionario', resultado.dados.mensagem, 'erro');
      }
    });

    // Listar Funcion√°rios
    document.getElementById('formListarFuncionarios').addEventListener('submit', async function(e) {
      e.preventDefault();
      const senha = document.getElementById('senhaSupervisorListar').value;
      
      const resultado = await fazerRequisicao(`/funcionarios?senha_supervisor=${senha}`);
      
      if (resultado.sucesso) {
        const funcionarios = resultado.dados;
        const lista = document.getElementById('listaFuncionarios');
        lista.innerHTML = '';
        
        if (funcionarios.length === 0) {
          lista.innerHTML = '<li>Nenhum funcion√°rio cadastrado.</li>';
        } else {
          funcionarios.forEach(func => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${func.nome}</strong> - Matr√≠cula: ${func.matricula}`;
            lista.appendChild(li);
          });
        }
        
        lista.classList.remove('hidden');
        mostrarResultado('resultadoListarFuncionarios', `Total de funcion√°rios: ${funcionarios.length}`, 'info');
        limparFormulario('formListarFuncionarios');
      } else {
        mostrarResultado('resultadoListarFuncionarios', resultado.dados.mensagem, 'erro');
      }
    });

    // Listar Funcion√°rios Logados
    async function listarFuncionariosLogados() {
      document.getElementById('loadingLogados').classList.remove('hidden');
      document.getElementById('resultadoLogados').classList.add('hidden');
      
      const resultado = await fazerRequisicao('/funcionarios-logados');
      
      document.getElementById('loadingLogados').classList.add('hidden');
      
      if (resultado.sucesso) {
        const funcionarios = resultado.dados;
        const lista = document.getElementById('listaFuncionariosLogados');
        lista.innerHTML = '';
        
        if (funcionarios.length === 0) {
          lista.innerHTML = '<li>Nenhum funcion√°rio logado.</li>';
        } else {
          funcionarios.forEach(func => {
            const li = document.createElement('li');
            li.innerHTML = `<strong>${func.nome}</strong> (Matr√≠cula: ${func.matricula})`;
            lista.appendChild(li);
          });
        }
        
        mostrarResultado('resultadoLogados', `Funcion√°rios logados: ${funcionarios.length}`, 'info');
      } else {
        mostrarResultado('resultadoLogados', resultado.dados.mensagem, 'erro');
      }
    }

    // Hist√≥rico por Matr√≠cula
    document.getElementById('formHistoricoMatricula').addEventListener('submit', async function(e) {
      e.preventDefault();
      const matricula = document.getElementById('matriculaHistorico').value;
      
      document.getElementById('loadingHistorico').classList.remove('hidden');
      document.getElementById('resultadoHistorico').classList.add('hidden');
      document.getElementById('listaHistorico').innerHTML = '';
      
      const resultado = await fazerRequisicao(`/historico-matricula?matricula=${matricula}`);
      
      document.getElementById('loadingHistorico').classList.add('hidden');
      
      if (resultado.sucesso) {
        const historico = resultado.dados;
        const lista = document.getElementById('listaHistorico');
        
        if (historico.length === 0) {
          lista.innerHTML = '<div class="historico-item">Nenhum registro encontrado.</div>';
        } else {
          historico.forEach(h => {
            let dataFormatada = '-';
            if (h.data) {
              const dt = new Date(h.data);
              dataFormatada = dt.toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            } else if (h.data_saida) {
              const dt = new Date(h.data_saida);
              dataFormatada = dt.toLocaleString('pt-BR', { timeZone: 'America/Sao_Paulo' });
            }
            
            const item = document.createElement('div');
            item.className = 'historico-item';
            item.innerHTML = `
              <strong>${dataFormatada}</strong> ‚Äî <b>${h.acao || '-'}</b> ‚Äî 
              <b>Placa:</b> ${h.placa || '-'} ‚Äî <b>Nome:</b> ${h.nome || '-'}
            `;
            lista.appendChild(item);
          });
        }
        
        mostrarResultado('resultadoHistorico', `Registros encontrados: ${historico.length}`, 'info');
        limparFormulario('formHistoricoMatricula');
      } else {
        mostrarResultado('resultadoHistorico', resultado.dados.mensagem, 'erro');
      }
    });

    // Ver Hist√≥rico Completo
    async function verHistoricoCompleto() {
      document.getElementById('loadingHistoricoCompleto').classList.remove('hidden');
      document.getElementById('resultadoHistoricoCompleto').classList.add('hidden');
      document.getElementById('listaHistoricoCompleto').innerHTML = '';
      
      const resultado = await fazerRequisicao('/historico');
      
      document.getElementById('loadingHistoricoCompleto').classList.add('hidden');
      
      if (resultado.sucesso) {
        const historico = resultado.dados.historico;
        const lista = document.getElementById('listaHistoricoCompleto');
        
        if (historico === 'üì≠ Nenhum registro no hist√≥rico.') {
          lista.innerHTML = '<div class="historico-item">Nenhum registro no hist√≥rico.</div>';
        } else {
          const registros = historico.split('\n');
          registros.forEach(registro => {
            if (registro.trim()) {
              const item = document.createElement('div');
              item.className = 'historico-item';
              item.textContent = registro;
              lista.appendChild(item);
            }
          });
        }
        
        mostrarResultado('resultadoHistoricoCompleto', 'Hist√≥rico carregado com sucesso!', 'sucesso');
      } else {
        mostrarResultado('resultadoHistoricoCompleto', resultado.dados.mensagem, 'erro');
      }
    }

    // Remover Funcion√°rio
    document.getElementById('formRemoverFuncionario').addEventListener('submit', async function(e) {
      e.preventDefault();
      const formData = new FormData(this);
      const dados = Object.fromEntries(formData);
      
      const resultado = await fazerRequisicao('/remover-funcionario', dados, 'POST');
      
      if (resultado.sucesso) {
        mostrarResultado('resultadoRemoverFuncionario', resultado.dados.mensagem, 'sucesso');
        limparFormulario('formRemoverFuncionario');
      } else {
        mostrarResultado('resultadoRemoverFuncionario', resultado.dados.mensagem, 'erro');
      }
    });

    // Listar Ve√≠culos Cadastrados
    async function listarVeiculosCadastrados() {
      document.getElementById('loadingVeiculos').classList.remove('hidden');
      document.getElementById('resultadoVeiculos').classList.add('hidden');
      document.getElementById('listaVeiculos').innerHTML = '';
      
      const senha = prompt('Digite a senha do supervisor:');
      if (!senha) {
        document.getElementById('loadingVeiculos').classList.add('hidden');
        mostrarResultado('resultadoVeiculos', 'Opera√ß√£o cancelada.', 'info');
        return;
      }
      
      const resultado = await fazerRequisicao(`/veiculos?senha_supervisor=${senha}`);
      
      document.getElementById('loadingVeiculos').classList.add('hidden');
      
      if (resultado.sucesso) {
        const veiculos = resultado.dados;
        const lista = document.getElementById('listaVeiculos');
        
        if (veiculos.length === 0) {
          lista.innerHTML = '<div class="historico-item">Nenhum ve√≠culo cadastrado.</div>';
        } else {
          veiculos.forEach(veiculo => {
            const item = document.createElement('div');
            item.className = 'historico-item';
            item.innerHTML = `
              <strong>Placa:</strong> ${veiculo.placa} | 
              <strong>Nome:</strong> ${veiculo.nome} | 
              <strong>Tipo:</strong> ${veiculo.tipo} | 
              <strong>CPF:</strong> ${veiculo.cpf} | 
              <strong>Modelo:</strong> ${veiculo.modelo || 'N/A'} | 
              <strong>Bloco:</strong> ${veiculo.bloco} | 
              <strong>Apto:</strong> ${veiculo.apartamento}
            `;
            lista.appendChild(item);
          });
        }
        
        mostrarResultado('resultadoVeiculos', `Total de ve√≠culos: ${veiculos.length}`, 'info');
      } else {
        mostrarResultado('resultadoVeiculos', resultado.dados.mensagem, 'erro');
      }
    }

    // Carregar funcion√°rios logados ao iniciar a p√°gina
    document.addEventListener('DOMContentLoaded', function() {
      listarFuncionariosLogados();
    });
  </script>
</body>
</html> 